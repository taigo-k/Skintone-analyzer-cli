# -*- coding: utf-8 -*-
"""SkinTone Analyzer.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vOsONlOUWw_Q8CvD1DZkKzrc3GIrE29f
"""

!pip install Pillow

from google.colab import drive
drive.mount('/content/drive')

import os
import math
from PIL import Image
from typing import Union, Tuple

# ç”»åƒã‹ã‚‰å¹³å‡RGBå€¤ã‚’å–ã‚Šå‡ºã™
def calculate_average_rgb(image_path: str) -> Union[Tuple[int, int, int], None]:
    if not os.path.exists(image_path):
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ« '{image_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return None
    try:
        img = Image.open(image_path)

        max_size = 100 # å‡¦ç†é€Ÿåº¦ã‚’ä¸Šã’ã‚‹ãŸã‚ã€ç”»åƒã‚µã‚¤ã‚ºã‚’èª¿æ•´
        if img.width > max_size or img.height > max_size:
            img = img.resize((max_size, int(img.height * max_size / img.width)))

        img = img.convert("RGB") # è‰²è¡¨ç¾ã‚’RGBå½¢å¼ã«çµ±ä¸€

        r_sum, g_sum, b_sum = map(sum, zip(*img.getdata()))
        total_pixels = img.width * img.height # ãƒ”ã‚¯ã‚»ãƒ«ç·æ•°

        avg_r = int(round(r_sum / total_pixels))
        avg_g = int(round(g_sum / total_pixels))
        avg_b = int(round(b_sum / total_pixels))

        return (avg_r, avg_g, avg_b) # RGBå¹³å‡å€¤

    except Exception as e:
        print(f"âŒ ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

def rgb_to_hsb(r_int: int, g_int: int, b_int: int) -> Tuple[int, int, int]: # RGBå€¤ã‚’å—ã‘å–ã‚Šã€HSBï¼ˆè‰²ç›¸ã€å½©åº¦ã€æ˜åº¦ï¼‰ã‚’è¿”ã™
  # 0 ~ 1ã«æ­£è¦åŒ–
  r = r_int / 255.0
  g = g_int / 255.0
  b = b_int / 255.0

  v = max(r, g, b) # æ˜åº¦
  c = v - min(r, g, b) # è‰²ã®æ¿ƒã•
  s = c / v if v != 0 else 0 # å½©åº¦

  if c == 0:
    h = 0
  elif v == r:
    h = (g - b) / c
  elif v == g:
    h = (b - r) / c + 2
  else:
    h = (r - g) / c + 4

  h *= 60 # 0 ~ 360Â°ã«å¤‰æ›
  if h < 0: # æ­£ã®å€¤ã«ã™ã‚‹
    h += 360

  return int(round(h)), int(round(s * 100)), int(round(v * 100))

def analyze_skin_tone(h: int, s: int, v: int) -> str: # HSBå€¤ã‚’å—ã‘å–ã‚‹

    # ã‚¤ã‚¨ãƒ™åˆ¤å®š
    if 10 <= h <= 60:
      base_tone = "ğŸŸ¡ ã‚¤ã‚¨ãƒ™ï¼ˆWarmï¼‰"
      if v >= 70 and s >= 30:
          return f"{base_tone} / ğŸŒ¸ æ˜¥ (Spring)"
      else:
          return f"{base_tone} / ğŸ ç§‹ (Autumn)"

    # ãƒ–ãƒ«ãƒ™åˆ¤å®š
    elif 200 <= h <= 280:
      base_tone = "ğŸ”µ ãƒ–ãƒ«ãƒ™ï¼ˆCoolï¼‰"
      if v >= 65 and s < 30:
          return f"{base_tone} / ğŸ–ï¸ å¤ (Summer)"
      else:
          return f"{base_tone} / â„ï¸ å†¬ (Winter)"

    # ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«åˆ¤å®š
    else:
      return "ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ« (åˆ¤å®šä¸èƒ½)"

def main_cli():
    """SkinTone Analyzer ã®ãƒ¡ã‚¤ãƒ³ã®å¯¾è©±å‹CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"""
    print("--------------------------------------------------")
    print("âœ¨ SkinTone Analyzer CLI âœ¨")
    print("  è‰²åˆ†æã‚’é–‹å§‹ã—ã¾ã™ã€‚")
    print("  çµ‚äº†ã™ã‚‹å ´åˆã¯ 'end' ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    print("--------------------------------------------------")

    # Google Driveã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’è¨­å®š
    drive_base_path = '/content/drive/MyDrive/'

    while True:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›å—ä»˜
        input_path = input(f"\nç”»åƒãƒ‘ã‚¹ã‚’å…¥åŠ› (ä¾‹: sample01.jpg): ")

        if input_path.lower() in ['end']:
            print("ğŸ‘‹ åˆ†æã‚’çµ‚äº†ã—ã¾ã™ã€‚")
            break

        # ãƒ•ãƒ«ãƒ‘ã‚¹ã«çµåˆ
        full_path = os.path.join(drive_base_path, input_path)

        # 1. RGBè¨ˆç®—
        avg_color = calculate_average_rgb(full_path)

        if avg_color is None:
            continue # ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯é–¢æ•°å†…ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ãŸã‚ç¶šè¡Œ

        r, g, b = avg_color

        # 2. HSBè¨ˆç®—
        h, s, v = rgb_to_hsb(r, g, b)

        # 3. ãƒˆãƒ¼ãƒ³åˆ¤å®š
        tone_result = analyze_skin_tone(h, s, v)

        # 4. çµæœã®å‡ºåŠ›ï¼ˆ2æ¡ã®16é€²æ•°ï¼‰
        hex_color = f"#{r:02x}{g:02x}{b:02x}".upper()

        print("\n--- [ åˆ†æçµæœ ] -----------------------------------")
        print(f"  ãƒ•ã‚¡ã‚¤ãƒ«: {input_path}")
        print(f"  å¹³å‡RGB: ({r}, {g}, {b}) / HEX: {hex_color}")
        print(f"  è‰²ç›¸: {h}Â°/ å½©åº¦: {s}% / æ˜åº¦: {v}%")
        print("----------------------------------------------------")
        print(f"  ğŸ¯ ç·åˆåˆ¤å®š: {tone_result}")
        print("----------------------------------------------------")

# ãƒ¡ã‚¤ãƒ³å‡¦ç†ã®é–‹å§‹
if __name__ == '__main__':
    main_cli()

